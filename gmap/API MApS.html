<!DOCTYPE html>
<html>
  <head lang="fr">
    
    <title>Google Maps JavaScript API v3 Example: Map Geolocation</title>
    
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no">
    <meta charset="utf-8">
    
    <link href="styleTest.css" rel="stylesheet">
    
    <!--
    Include the maps javascript with sensor=true because this code is using a
    sensor (a GPS locator) to determine the user's location.
    See: https://developers.google.com/apis/maps/documentation/javascript/basics#SpecifyingSensor
    -->
    
    <script src="https://maps.googleapis.com/maps/api/js?sensor=false"></script>
    <script type="text/javascript" src="jquery.js"></script>

    <script>

        var map;
        var marker;
        var nouveau_marqueur;
        var position_utilisateur;
        var position_initiale;
        var nouvelle_icone = "marker.png"; //pour changer le marqueur par défaut de Google Maps
        var test_geolocation; // true = geolocation marche
        var data; //pour récupérer le contenu du ficher JSON
        var tableau_markers=new Array(); // tableau contenant les markers pour pouvoir les supprimer

        // cette fonction sert à initialiser la carte et trouver la position de l'utilisateur
        function initialize() {
        
            detection_systeme(); // si on utilise un smartphone, on modifie l'affiche de la carte (pour la voir à 100%)
        
            var mapOptions = { // les options par défaut de la carte
                zoom: 13,
                mapTypeId: google.maps.MapTypeId.ROADMAP
            };

            map = new google.maps.Map(document.getElementById('map_canvas'),mapOptions); // on construit la carte et l'affiche dans la div "map_canvas"

            // on vérifie si le navigateur supporte la géolocalisation ...
            if(navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(function(position) {
                    position_initiale = new google.maps.LatLng(position.coords.latitude,position.coords.longitude);
                    map.setCenter(position_initiale);
                }, function() {
                    // ... et s'il ne peut pas on rentre dans la fonction "handleNoGeolocation"
                    test_geolocation = true;
                    handleNoGeolocation(test_geolocation);
                });
            } else { 
                test_geolocation = false;
                handleNoGeolocation(test_geolocation);
            }
        }

        function handleNoGeolocation(errorFlag) {
            if (errorFlag) {
                var content = 'Erreur : la géolocalisation n\'a pas marchée, nous vous avons placé sur Paris.' ;
            } else {
                var content = 'Erreur : votre navigateur ne supporte pas la géolocalisation, nous vous avons placé sur Paris.';
            }

            var options = {
                map: map,
                position: new google.maps.LatLng(48.858165,2.350674), //la position par défaut sera Paris
                content: content
            };

            var infowindow = new google.maps.InfoWindow(options);
            map.setCenter(options.position);
        }

        function detection_systeme() { 

            //cette fonction permet de redimensionner la div contenant la carte si l'on possède un smatphone
            var useragent = navigator.userAgent;
            var taille_div = document.getElementById("map_canvas");

            if (useragent.indexOf('iPhone') != -1 || useragent.indexOf('Android') != -1 ) {
                taille_div.style.width = '100%';
                taille_div.style.height = '100%';
            } else {
                taille_div.style.width = '800px';
                taille_div.style.height = '250px';
            }
        }

        function changer_localisation(new_localisation) { 

            //permet de changer de localisation en fonction de la liste déroulante (et de revenir sur la géolocalisation si l'on veut ^^)

            $.getJSON('localisation_ANPE.json', function(data) {

                $.each(data.ville, function (index_ville, donnees) {
                    
                    if (index_ville == new_localisation && new_localisation != 4) {
                       
                        $.each(donnees, function (index_coord, objet) {
                            
                            for(i=0;i<objet.length;i++) {

                                // objet[i] renvoie un string, il faut donc splitter sa valeur pour obtenir la lat et la lng séparemment et ainsi réutiliser les deux pour avoir les coordonnées des ANPE

                                var latlng = objet[i].split(",");
                                var latlng_principale = objet[0].split(",");                  
                                nouveau_marqueur = new google.maps.Marker({
                                    position: new google.maps.LatLng(latlng[0],latlng[1]),
                                    map: map,
                                    icon: nouvelle_icone
                                });

                                tableau_markers.push(nouveau_marqueur);
                                map.setCenter(new google.maps.LatLng(latlng_principale[0],latlng_principale[1]));
                            }

                        });
                        //permet de sortir de la boucle quand on a trouvé le résultat (ville choisie)
                        return false; 
                    }

                    else if (new_localisation == 4) {
                        console.log("new_localisation == 4");
                        if(navigator.geolocation) {                           
                            if (test_geolocation == true) 
                            {
                                handleNoGeolocation(test_geolocation);
                            }
                            position_utilisateur = position_initiale;
                        }
                        else {
                            handleNoGeolocation(test_geolocation);
                        }
                        return false;
                    }

                });

            });

            if (marker != null) {
                marker.setMap(null);
            }
            
            if (nouveau_marqueur != null) {
                remove_markers();
            }

        }

        function remove_markers() {
            for (i=0;i<tableau_markers.length;i++) {
                tableau_markers[i].setMap(null);
            }
        }


    </script>
  
  </head>
  
  <body onLoad="initialize()">
    
    <div class="conteneur">
        
        <h1>Test Google Maps</h1> 
        <div id="map_canvas"></div>

        <select onchange="changer_localisation(this.value)">
        
            <option value="4">Votre localisation</option>
            <option value="0">Paris</option>
            <option value="1">Lyon</option>
            <option value="2">Limoges</option>
            <option value="3">Orléans</option>
            
        </select>

        <div id="test"></div>

    </div>

    </body>

</html>